#!/bin/sh
# IBM(c) 2007 EPL license http://www.eclipse.org/legal/epl-v10.html
#egan@us.ibm.com
#(C)IBM Corp
#

if [ ! -x /usr/bin/openssl ]; then #Unless we have openssl stup
   exit 0
fi
   allowcred.awk &
   CREDPID=$!
   sleep 1
   mkdir -p /root/.xcat
   chmod 700 /root/.xcat
   getcredentials.awk xcat_client_cred | grep -v '<'|sed -e 's/&lt;/</' -e 's/&gt;/>/' -e 's/&amp;/&/' -e 's/&quot/"/' -e "s/&apos;/'/" > /root/.xcat/client-cred.pem
   CONT=`cat /root/.xcat/client-cred.pem`
   while [ -z "$CONT" ]; do
    let SLI=$RANDOM%10+10
    sleep $SLI
    getcredentials.awk xcat_client_cred | grep -v '<'|sed -e 's/&lt;/</' -e 's/&gt;/>/' -e 's/&amp;/&/' -e 's/&quot/"/' -e "s/&apos;/'/" > /root/.xcat/client-cred.pem
     CONT=`cat /root/.xcat/client-cred.pem`
   done
   chmod 600 /root/.xcat/client-cred.pem
   cp _xcat/ca.pem /root/.xcat/ca.pem
   kill -9 $CREDPID
