#!/bin/sh
# IBM(c) 2007 EPL license http://www.eclipse.org/legal/epl-v10.html

#-------------------------------------------------------------------------------
#=head1  otherpkgs
#=head2  It gets the extra rpms and install/update them.
#        The environment variable OTHERPKGS contains the rpms to be installed/updated.
#        On MN, You need to:
#        1. put rpms under /install/post/otherpkgs/os/arch directory where 'os' and 'arch'
#           can be found in the nodetype table.
#        2. put the name of the packages to /opt/xcat/share/xcat/netboot(install)/platform
#           directory. The file name is one of the following:
#              profile.os.arch.otherpkgs.pkglist  
#              profile.os.otherpkgs.pkglist   
#              profile.arch.otherpkgs.pkglist  
#              profile.otherpkgs.pkglist
#   The install/deployment process will pick up the rpms and install them on the nodes. 
#   However, if the nodes have already installed and up and running, you can run the following
#   command to have the extra rpms installed:
#       updatenode noderange otherpkgs 
#   
#=cut
#-------------------------------------------------------------------------------

#echo "OTHERPKGS=$OTHERPKGS"
if [[ -z "$OTHERPKGS" ]]; then 
  echo "$0: no extra rpms to install"
  exit 0
fi

if [[ -z "$NFSSERVER" ]]; then
    NFSSERVER=$MASTER
fi


#check if /install is mounted on the server, we may need to add code to conver NFSSERVER to ip 
mounted=0;
result=`mount |grep /install |grep $NFSSERVER`
if [ $? -eq 0 ]; then
    if [[ -z "$INSTALLDIR" ]]; then
        NFSSERVER="/install"
    else
        NFSSERVER=$INSTALLDIR
    fi
    mounted=1 
fi

#echo NFSSERVER=$NFSSERVER

#check if the node has yum or zypper installed, it will try yum first, then zypper and last rpm
hasyum=0  
haszypper=0;          
result=`rpm -q yum`
if [ $? -eq 0 ]; then 
    hasyum=1
    mkdir -p /etc/yum.repos.d
    result=`rm /etc/yum.repos.d/xCAT-otherpkgs*.repo 2>&1`
    result=`yum clean all`
    repo_base="/etc/yum.repos.d"
else
    result=`rpm -q zypper`
    if [ "$?" = "0" ]; then 
	haszypper=1
        #remove old repo
        old_repo=`zypper lr -u |grep xcat-otherpkgs | cut -f2 -d '|'`
        for x in $old_repo
        do
            result=`zypper sd $x`
        done
        repo_base="/tmp"
    fi
fi


repo_path=()
repo_pkgs=""
plain_pkgs=""
for x in `echo "$OTHERPKGS" | tr "," "\n"`
do
    if [ $hasyum -eq 0 ] && [ $haszypper -eq 0 ]; then
	plain_pkgs="$plain_pkgs $x-*"
	continue
    fi
	
   fn=`basename $x`
   path=`dirname $x`
   whole_path=$NFSSERVER/post/otherpkgs/$OSVER/$ARCH/$path

   #find out if this path has already saved added in the repo
   try_repo=1
   rc=1
   i=0
   while [ $i -lt ${#repo_path[*]} ]; do
       if [ ${repo_path[$i]} = $path ]; then
           try_repo=0
           rc=0
           break 
       fi
       let i++
   done

   #try to add the path to the repo
   if [ $try_repo -eq 1 ]; then
       index=${#repo_path[*]}
       REPOFILE="$repo_base/xCAT-otherpkgs$index.repo"
       echo "[xcat-otherpkgs$index]" > $REPOFILE
       echo "name=xcat-otherpkgs$index" >> $REPOFILE
       if [ $mounted -eq 0 ]; then
           echo "baseurl=ftp://$whole_path" >> $REPOFILE
       else
           echo "baseurl=file://$whole_path" >> $REPOFILE
       fi
       echo "enabled=1" >> $REPOFILE
       echo "gpgcheck=0" >> $REPOFILE

       if [ $hasyum -eq 1 ]; then 
	   #use yum
           result=`yum list $fn 2>&1`
           if [ $? -eq 0 ]; then  
               rc=0
               repo_path[${#repo_path[*]}]=$path
           else
               rm $REPOFILE
	   fi
       elif [ $haszypper -eq 1 ]; then
           #use zypper
	   if [ "$OSVER" = "sles11" ]; then
	       result=`zypper ar -c $REPOFILE`
	   else
	       result=`zypper sa -c $REPOFILE` 
	   fi	

           result=`zypper refresh xcat-otherpkgs$index 2>&1`
           if [ $? -eq 0 ]; then  
	       rc=0
               repo_path[${#repo_path[*]}]=$path
           else
               result=`zypper sd xcat-otherpkgs$index`
	   fi
       fi
   fi
       
   if [ $rc -eq 0 ]; then
       repo_pkgs="$repo_pkgs $fn"  
   else
       #now no hope we have to use rpm command
       plain_pkgs="$plain_pkgs $x-*"
   fi
done  

#Now we have parse the input, let start the installation using yum or zypper     
if [ "$repo_pkgs" != "" ]; then
    if [ $hasyum -eq 1 ]; then 
        echo "yum -y install $repo_pkgs"
        result=`yum -y install $repo_pkgs 2>&1`
        echo "$result"
        if [ $? -ne 0 ]; then 
            logger "otherpkgs: $result"
        fi
    elif [ $haszypper -eq 1 ]; then
        echo "zypper install -y $repo_pkgs"
	result=`zypper install -y $repo_pkgs 2>&1`
        echo "$result"
	if [ $? -ne 0 ]; then 
            logger "otherpkgs: $result"
	fi
        #remove the repos
        old_repo=`zypper lr -u |grep xcat-otherpkgs | cut -f2 -d '|'`
        for x in $old_repo
        do
            result=`zypper sd $x`
        done
    fi
fi 

#Handle the rest with rpm
if [ "$plain_pkgs" != "" ]; then 
    if [ $mounted -eq 0 ]; then
        mkdir -p /xcatpost/post/otherpkgs/$OSVER/$ARCH; 
        rm -f -R /xcatpost/post/otherpkgs/*
        mkdir -p /tmp/postage/
        rm -f -R /tmp/postage/*
        cd /tmp/postage
    
        for x in `echo "$plain_pkgs" | tr " " "\n"`
        do
	    wget -l inf -N -r --waitretry=10 --random-wait --retry-connrefused -t 0 -T 60 ftp://$NFSSERVER/post/otherpkgs/$OSVER/$ARCH/$x 2> /tmp/wget.log  
        done
    
        mv $NFSSERVER/post/otherpkgs/* /xcatpost/post/otherpkgs; 
        rm -rf $NFSSERVER
        cd /xcatpost/post/otherpkgs/$OSVER/$ARCH
    else
        cd $NFSSERVER/post/otherpkgs/$OSVER/$ARCH
    fi

    echo "rpm -Uvh --replacepkgs $plain_pkgs" 
    result=`rpm -Uvh --replacepkgs $plain_pkgs 2>&1`
    #result=`rpm -Fvh $plain_pkgs 2>&1`
    echo "$result"
    if [ $? -ne 0 ]; then 
	logger "otherpkgs $result"
    fi
    
    if [ $mounted -eq 0 ]; then
        rm -f -R /xcatpost/post/otherpkgs/*
    fi
fi

exit 0


















