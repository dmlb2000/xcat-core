#
# Sample script to customize options for PE
# For AIX:
#    TBD
# For Linux:
#    - Create a smaller PNSD log file in /tmp 
#    - Configure poe.limits file

OS=`uname`
INSTALL_DIR='/install'
PE_DIR=$pedir

if [ -z $PE_DIR ]; then
   # try to default
   PE_DIR=$INSTALL_DIR/post/otherpkgs/$OSVER/$ARCH/pe
fi


if [ $NODESETSTATE != "genimage" ]; then
   # running as a postscript in a full-disk install or AIX diskless install
   installroot=""
fi



if [ $OS != "AIX" ]; then
    if [ $NODESETSTATE == "install" ]; then
    #  Being run from a stateful install postscript
    #  Copy rpms directly from the xCAT management node and install
        mkdir -p /tmp/pe
        rm -f -R /tmp/pe/*
        cd /tmp/pe
        download_dir=`echo $PE_DIR | cut -d '/' -f3-`
        wget -l inf -N -r --waitretry=10 --random-wait --retry-connrefused -t 0 -T 60 -nH --cut-dirs=3 ftp://$SITEMASTER/$download_dir/*.rpm 2> /tmp/wget.log
        rpm -Uvh IBM_pe_license*.rpm
        rpm -Uvh ibm_lapi*.rpm ibm_pe*.rpm ppe_*.rpm sci_*.rpm
        cd /
        rm -Rf /tmp/pe
    fi

    if [ $NODESETSTATE == "genimage" ]; then
    # Being called from <image>.postinstall script
    # Assume we are on the same machine
        chroot $installroot mount -t proc none /proc
        if [[ $OS = sles* ]] || [[ $OS = suse* ]] || [[ -f /etc/SuSE-release ]]; then
        # For SLES, assume zypper is available on the system running genimage

            IBM_PE_LICENSE_PROMPT=N zypper -R $installroot install $PE_DIR/IBM_pe_license*.rpm
            zypper -R $installroot install $PE_DIR/ibm_lapi*.rpm $PE_DIR/ibm_pe*.rpm $PE_DIR/ppe_*.rpm $PE_DIR/sci_*.rpm
        else
        # For Redhat, etc., assume yum is available on the system running genimage
             IBM_PE_LICENSE_PROMPT=N yum --installroot $installroot --nogpgcheck localupdate  $PE_DIR/IBM_pe_license*.rpm
             yum --installroot $installroot --nogpgcheck localupdate $PE_DIR/ibm_lapi*.rpm $PE_DIR/ibm_pe*.rpm $PE_DIR/ppe_*.rpm $PE_DIR/sci_*.rpm
        fi
        umount -l $installroot/proc
    fi
fi



# Configure the PNSD.cfg to use a smaller log so it doesn't use so much memory
# for a stateless image.  Normally, pnsd creates this file if it does not 
# exist, but it will not fill it in if it does exist.
if [ ! -f $installroot/etc/PNSD.cfg ]; then
    echo "log_file = /tmp/serverlog" > $installroot/etc/PNSD.cfg
    echo "log_file_size = 2097152" >> $installroot/etc/PNSD.cfg
    echo "socket_file = /tmp/PNSD" >> $installroot/etc/PNSD.cfg
else
    /usr/bin/sed -i 's/log_file_size = .*/log_file_size = 2097152/g'  $installroot/etc/PNSD.cfg
fi

# Configure the poe.limits file
if [ ! -f $installroot/etc/poe.limits ]; then
    echo "MP_POE_LAUNCH=all" > $installroot/etc/poe.limits
else
    /usr/bin/sed -i 's/MP_POE_LAUNCH=.*/MP_POE_LAUNCH=all/g'  $installroot/etc/poe.limits
fi

