# IBM(c) 2007 EPL license http://www.eclipse.org/legal/epl-v10.html
#
# Raw commands to set BMCs to defaults
#   dx320
#     0x2e 0x10 0x4d 0x4f 0x00 0xff
#
#   dx340 
#     0x30 0x13 0xff 0x00 0x00 0x00
#
#   dx360/x3450
#     0x30 0x02 0x43 0x4c 0x52 0xaa
#     0x08 0x00 0x49 0x4e 0x54 0x45 0x4c
#     0x08 0x04
#
allowcred.awk &
CREDPID=$!
modprobe ipmi_si
modprobe ipmi_devintf
while ! getipmi
do
    echo "Retrying retrieval of IPMI settings from server"
done
kill $CREDPID
BMCIP=`grep bmcip /tmp/ipmi.data |awk -F\> '{print $2}'|awk -F\< '{print $1}'`
BMCGW=`grep gateway /tmp/ipmi.data |awk -F\> '{print $2}'|awk -F\< '{print $1}'`
BMCNM=`grep netmask /tmp/ipmi.data |awk -F\> '{print $2}'|awk -F\< '{print $1}'`
BMCUS=`grep username /tmp/ipmi.data |awk -F\> '{print $2}'|awk -F\< '{print $1}'`
BMCPW=`grep password /tmp/ipmi.data |awk -F\> '{print $2}'|awk -F\< '{print $1}'`
while ! ipmitool lan set 1 ipsrc static; do
    sleep 1
done
while ! ipmitool lan set 1 ipaddr $BMCIP; do
    sleep 1
done
while ! ipmitool lan set 1 netmask $BMCNM; do
    sleep 1
done
if [ ! -z "$BMCGW" ]; then
    while ! ipmitool lan set 1 defgw ipaddr $BMCGW; do
        sleep 1
    done
fi
while ! ipmitool user disable 1; do
    sleep 1
done
while ! ipmitool user disable 3; do
    sleep 1
done
while ! ipmitool user disable 4; do
    sleep 1
done
while ! ipmitool user enable 2; do
    sleep 1
done
while ! ipmitool user priv 2 4 1; do
    sleep 1
done
while ! ipmitool user set name 2 $BMCUS; do
    sleep 1
done
while ! ipmitool user set password 2 $BMCPW; do
    sleep 1
done
echo "Set up following user table: "
ipmitool user list 1


echo "Enabling Channel 1: "
while ! ipmitool raw 0x6 0x40 0x1 0x42 0x44; do
    sleep 1
done
while ! ipmitool raw 0x6 0x40 0x1 0x82 0x84; do
    sleep 1
done

echo "Enabling ARP responses: "
while ! ipmitool lan set 1 arp respond on; do
    sleep 1
done

echo "Enabling IPMI v 1.5 MD5 LAN access:"
while ! ipmitool lan set 1 auth admin md5; do
    sleep 1
done

echo "Enabling IPMI v 2.0 LAN access:"
while ! ipmitool lan set 1 cipher_privs uaaaXXXXXXXXXXX; do
    sleep 1
done

echo "Enabling SOL for channel 1"
while ! ipmitool raw 0xc 0x21 0x1 0x1 0x1; do
    sleep 1
done

echo "Enabling SOL for user 2"
while ! ipmitool raw 6 0x4c 1 2 2 0 0 0; do
    sleep 1
done

allowcred.awk &
CREDPID=$!
frume.awk
kill $CREDPID

echo "Lighting Identify Light"
while :
    do ipmitool raw 0 4 10
    sleep 5
done &

