#!/bin/sh

#  This script packages the AIX RPM dependencies
#    - it should be run in the ../xcat/xcat-core/trunk directory
#    - it puts everything in a aix-dep-snap subdirectory

BLDTOP=`pwd`
RPMDIR=$BLDTOP/aix-dep-snap
VER=`cat $BLDTOP/Version`

if [ -d $RPMDIR ]
then
  # clean it up
  rm -f $RPMDIR/instoss
  rm -f $RPMDIR/instmysql
  rm -f $RPMDIR/README
  rm -f $RPMDIR/*.rpm
  rm -f $RPMDIR/*.bnd
  rm -f $RPMDIR/flist
  rm -f $RPMDIR/flist2
  rm -f $RPMDIR/*.gz
else
  mkdir -p $RPMDIR
fi

cd $RPMDIR

# build tar.gz for default required RPMs and a second tar.gz for mysql

# create a simple install script
echo "# xCAT on AIX - prerequisite install script" > $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-DBI-1.55-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-DBI-1.55-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-DBD-SQLite-1.13-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-DBD-SQLite-1.13-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/tcl-8.4.7-3.aix5.1.ppc.rpm $RPMDIR/
echo "rpm -Uvh tcl-8.4.7-3.aix5.1.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/tk-8.4.7-3.aix5.1.ppc.rpm $RPMDIR/
echo "rpm -Uvh tk-8.4.7-3.aix5.1.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/expect-5.42.1-3.aix5.1.ppc.rpm $RPMDIR/
echo "rpm -Uvh expect-5.42.1-3.aix5.1.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/conserver-8.1.16-2.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh conserver-8.1.16-2.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-Expect-1.21-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-Expect-1.21-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-IO-Tty-1.07-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-IO-Tty-1.07-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-IO-Stty-.02-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-IO-Stty-.02-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-IO-Socket-SSL-1.06-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-IO-Socket-SSL-1.06-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-Net_SSLeay.pm-1.30-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-Net_SSLeay.pm-1.30-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-Digest-MD5-2.36-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-Digest-MD5-2.36-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/fping-2.4b2_to-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh fping-2.4b2_to-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/openslp-1.2.1-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh openslp-1.2.1-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

cp /opt/freeware/src/packages/RPMS/ppc/perl-Crypt-SSLeay-0.57-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-Crypt-SSLeay-0.57-1.aix5.3.ppc.rpm" >> $RPMDIR/instoss

# get the OSS README file
cp ./../../../xcat-dep/trunk/AIX/README $RPMDIR/

# add the bundle files to the dep packages
cp $BLDTOP/xCATaixSN.bnd $RPMDIR/
cp $BLDTOP/xCATaixSSH.bnd $RPMDIR/
cp $BLDTOP/xCATaixSSL.bnd $RPMDIR/

# make the default required RPM tar.gz file
ls *.rpm > $RPMDIR/flist
chmod +x $RPMDIR/instoss
echo "README" >> $RPMDIR/flist
echo "instoss" >> $RPMDIR/flist
echo "xCATaixSN.bnd" >> $RPMDIR/flist
echo "xCATaixSSH.bnd" >> $RPMDIR/flist
echo "xCATaixSSL.bnd" >> $RPMDIR/flist
tar -cvf $RPMDIR/dep-aix-$VER.tar -L $RPMDIR/flist
gzip $RPMDIR/dep-aix-$VER.tar

# make a second tar.gz for mysql packages
cp /opt/freeware/src/packages/RPMS/ppc/perl-DBD-mysql-4.007-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh perl-DBD-mysql-4.007-1.aix5.3.ppc.rpm" >> $RPMDIR/instmysql
echo "perl-DBD-mysql-4.007-1.aix5.3.ppc.rpm" > $RPMDIR/flist2

cp /opt/freeware/src/packages/RPMS/ppc/xcat-mysql-5.0-1.aix5.3.ppc.rpm $RPMDIR/
echo "rpm -Uvh xcat-mysql-5.0-1.aix5.3.ppc.rpm" >> $RPMDIR/instmysql
echo "xcat-mysql-5.0-1.aix5.3.ppc.rpm" >> $RPMDIR/flist2

chmod +x $RPMDIR/instmysql
echo "instmysql" >> $RPMDIR/flist2
echo "README" >> $RPMDIR/flist2
tar -cvf $RPMDIR/xcat-mysql-$VER.tar -L $RPMDIR/flist2
gzip $RPMDIR/xcat-mysql-$VER.tar

exit 0;
